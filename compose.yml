name: reactive_resume

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 20

  browserless:
    image: ghcr.io/browserless/chromium:latest
    restart: unless-stopped
    environment:
      - QUEUED=30
      - HEALTH=true
      - CONCURRENT=20
      - TOKEN=1234567890
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/pressure?token=1234567890"]
      interval: 10s
      timeout: 5s
      retries: 20

  # -------------------------------
  # SeaweedFS (master / volume / filer / s3)
  # -------------------------------

  seaweed-master:
    image: chrislusf/seaweedfs:latest
    restart: unless-stopped
    command: master -ip=seaweed-master -ip.bind=0.0.0.0 -port=9333
    ports:
      - "9333:9333"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:9333/cluster/status"]
      interval: 10s
      timeout: 5s
      retries: 20

  seaweed-volume:
    image: chrislusf/seaweedfs:latest
    restart: unless-stopped
    command: volume -ip=seaweed-volume -ip.bind=0.0.0.0 -port=8080 -mserver=seaweed-master:9333 -dir=/data
    depends_on:
      seaweed-master:
        condition: service_healthy
    volumes:
      - seaweedfs_data:/data
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/status"]
      interval: 10s
      timeout: 5s
      retries: 20

  seaweed-filer:
    image: chrislusf/seaweedfs:latest
    restart: unless-stopped
    command: filer -master=seaweed-master:9333 -ip=seaweed-filer -ip.bind=0.0.0.0 -port=8888
    depends_on:
      seaweed-master:
        condition: service_healthy
      seaweed-volume:
        condition: service_healthy
    ports:
      - "8888:8888"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8888/"]
      interval: 10s
      timeout: 5s
      retries: 20

  seaweed-s3:
    image: chrislusf/seaweedfs:latest
    restart: unless-stopped
    command: s3 -filer=seaweed-filer:8888 -ip.bind=0.0.0.0 -port=8333
    environment:
      # âœ… Provide fallback admin creds so bucket creation + app auth works
      - AWS_ACCESS_KEY_ID=seaweedfs
      - AWS_SECRET_ACCESS_KEY=seaweedfs
    depends_on:
      seaweed-filer:
        condition: service_healthy
    ports:
      - "8333:8333"
    healthcheck:
      # robust healthcheck that doesn't require a 200 response
      test: ["CMD-SHELL", "wget -q -S -O - http://localhost:8333/ 2>&1 | head -n 1 | grep -E 'HTTP/' >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 30

  seaweedfs-create-bucket:
    image: quay.io/minio/mc:latest
    restart: on-failure
    entrypoint: >
      /bin/sh -c "
        sleep 3;
        mc alias set seaweedfs http://seaweed-s3:8333 seaweedfs seaweedfs;
        mc mb -p seaweedfs/reactive-resume || true;
        exit 0;
      "
    depends_on:
      seaweed-s3:
        condition: service_healthy

  # -------------------------------
  # Reactive Resume App
  # -------------------------------

  app:
    image: lxrbckl/reactive-resume:main
    restart: unless-stopped
    environment:
      # --- Server ---
      - TZ=Etc/UTC
      - NODE_ENV=production
      - APP_URL=<host-domain>

      # Printer
      - PRINTER_APP_URL=http://app:3000
      - PRINTER_ENDPOINT=ws://browserless:3000?token=1234567890

      # Database
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/postgres

      # Auth
      # openssl rand -hex 32
      - AUTH_SECRET=REPLACE_ME_WITH_RANDOM_HEX

      # Storage (SeaweedFS S3)
      - S3_ACCESS_KEY_ID=seaweedfs
      - S3_SECRET_ACCESS_KEY=seaweedfs
      - S3_REGION=us-east-1
      - S3_ENDPOINT=http://seaweed-s3:8333
      - S3_BUCKET=reactive-resume
      - S3_FORCE_PATH_STYLE=true

      # Feature Flags
      - FLAG_DEBUG_PRINTER=false
      - FLAG_DISABLE_SIGNUPS=false
      - FLAG_DISABLE_EMAIL_AUTH=false

    volumes:
      - reactive_resume_data:/app/data
    ports:
      - "8180:3000"
    depends_on:
      postgres:
        condition: service_healthy
      browserless:
        condition: service_healthy
      seaweedfs-create-bucket:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 20

volumes:
  postgres_data:
  seaweedfs_data:
  reactive_resume_data:
